import { Category, StylePreset } from './types';

// 업종별 스타일 규칙 (고도화 버전)
const categoryStyles: Record<Category, { tone: string; structure: string; rules: string; details: string }> = {
  '네일': {
    tone: '디테일 중심의 편안하고 섬세한 톤',
    structure: '디자인 선택 → 시술 과정 → 디테일 강조 → 완성 후 느낌',
    rules: '네일 아트 디테일 강조 (컬러, 패턴, 질감, 마감). 시술 중 편안함과 전문성 묘사. 손톱 상태 변화 관찰. 가벼운 대화체 자연스럽게 사용.',
    details: '디자인 선택 과정을 구체적으로 서술하고, 시술 중 느낀 편안함과 전문가의 섬세함을 표현한다. 완성 후의 디테일과 질감을 생생하게 묘사하되, 과장된 표현은 피한다.',
  },
  '속눈썹/눈썹/메이크업': {
    tone: '변화와 디테일 중심의 섬세한 톤',
    structure: '상담 → 디자인 선택 → 시술 과정 → 변화 관찰 → 만족도',
    rules: '속눈썹/눈썹 컬, 두께, 길이, 각도 등 구체적 디테일. 메이크업의 색감, 질감, 지속력. 시술 중 편안함과 전문가의 기술력. 자연스러운 변화 강조.',
    details: '시술 전후의 변화를 구체적으로 관찰하고, 디테일한 부분(컬의 방향, 색감의 자연스러움 등)을 섬세하게 묘사한다. 전문가의 기술과 상담 능력을 자연스럽게 강조하되, 과장은 피한다.',
  },
  '왁싱/피부관리/체형관리': {
    tone: '안정적·차분·신뢰 기반의 전문적 톤',
    structure: '상담 → 과정 설명 → 시술 경험 → 느낌 → 결과 관찰',
    rules: '의료법 금지 표현 자동 제거. 시술 과정은 "느낌 중심", 효과 단정 금지. 시술 중 편안함과 전문성. 피부 상태 변화 관찰. 체형 관리의 과정과 방법 설명.',
    details: '상담·청결·조도·설명력 중심으로 자연스럽게 서술하되, 과장이나 효과 보장 표현은 절대 사용하지 않는다. 시술 중 느낀 편안함과 전문가의 케어를 구체적으로 표현한다.',
  },
  '미용실': {
    tone: 'Before→After 변화 중심의 생동감 있는 톤',
    structure: 'Before 상태 → 상담 및 제안 → 시술 과정 → After 변화 → 만족도',
    rules: '헤어 질감·볼륨·광택 등 촉각적 표현. 디자이너의 제안·설명력·기술력 강조. 변화의 자연스러움과 스타일링의 편의성. 시술 중 대화와 분위기.',
    details: '변화를 명확하게 보여주되 과장하지 않고, 실제 느낀 질감과 변화를 구체적으로 묘사한다. 디자이너의 전문성과 상담 능력을 자연스럽게 강조한다.',
  },
  '꽃집/공방': {
    tone: '감성과 디테일 중심의 따뜻한 톤',
    structure: '방문 계기 → 공간 분위기 → 작품/상품 관찰 → 제작 과정/서비스 → 감상',
    rules: '공간의 감성적 분위기 (향, 색감, 조명). 작품/상품의 디테일과 의미. 제작 과정의 섬세함. 직원의 친절함과 전문성. 구매/체험 경험의 만족도.',
    details: '공간의 감성적 분위기와 작품의 디테일을 구체적으로 묘사한다. 제작 과정이나 서비스의 섬세함을 자연스럽게 표현하되, 과도한 감성 표현은 피한다.',
  },
  '맛집/술집': {
    tone: '방문 흐름 기반의 생동감 있고 친근한 톤',
    structure: '입장 → 분위기 관찰 → 주문 → 음식/술 경험 → 식사/마시기 → 마무리',
    rules: '방문 흐름 기반 서사. 음식/술의 향→맛→식감 순서. 분위기와 공간감. 직원의 서비스. 과장형 감탄 금지. 자연스러운 만족도 표현.',
    details: '음식과 술의 식감과 맛을 구체적이고 생생하게 표현하되, "최고다" 같은 과장 표현은 사용하지 않는다. 공간의 분위기와 서비스를 자연스럽게 묘사한다.',
  },
  '카페/디저트': {
    tone: '향·식감·공간 분위기 중심의 감성적이고 편안한 톤',
    structure: '방문 계기 → 공간 분위기 → 메뉴 선택 → 감각 묘사 → 디저트 경험 → 분위기',
    rules: '향·식감·소리·온도 등 오감 묘사. 공간 분위기·빛·좌석감 중심. 메뉴와 디저트 1~2개 집중 묘사. 커피/차의 향과 맛의 디테일. 감성적이되 과장 없는 표현.',
    details: '다섯 감각을 활용한 생생한 묘사를 자연스럽게 녹여내되, 과장된 표현은 피한다. 공간의 분위기와 메뉴의 디테일을 구체적으로 표현한다.',
  },
  'PT/필라테스': {
    tone: '설명력·안전감·전문성 중심의 신뢰 기반 톤',
    structure: '목표 설정 → 프로그램 설명 → 동작 수행 → 체감 변화 → 만족도',
    rules: '강사/트레이너의 설명력·케어·전문성. 동작 수행 시 느낌과 자세 교정. 공간 안전감·기구 상태·청결도 묘사. 체계적인 프로그램 구성. "효과 단정" 금지.',
    details: '안전한 운동 방법과 체계적인 프로그램을 강조하며, 성과 보장 표현(예: 살 빠진다)은 절대 사용하지 않는다. 강사의 전문성과 개인별 맞춤 케어를 자연스럽게 표현한다.',
  },
  '스포츠/운동': {
    tone: '활동성과 경험 중심의 역동적인 톤',
    structure: '참여 계기 → 시설/장비 관찰 → 활동 경험 → 체감 → 만족도',
    rules: '시설의 안전성과 청결도. 장비의 상태와 다양성. 활동 중 느낀 역동성과 즐거움. 지도자의 전문성. 공간의 활용성과 분위기. 과장된 성과 표현 금지.',
    details: '활동의 역동성과 즐거움을 생생하게 표현하되, 성과나 효과를 단정하는 표현은 피한다. 시설과 장비의 상태, 지도자의 전문성을 자연스럽게 강조한다.',
  },
  '자동차': {
    tone: '신뢰·과정 투명성·전문성 중심의 실용적 톤',
    structure: '방문 계기 → 상담 → 점검/서비스 과정 → 설명 → 결과 → 만족도',
    rules: '신뢰감·과정 투명성·정직성. 작업 이해도·설명력. 시설의 청결도와 전문성. 위험한 추정 금지 (고장 원인 단정 X). 정비/관리의 세심함.',
    details: '전문성과 신뢰감을 강조하며, 기술적 설명을 이해하기 쉽게 전달하되, 원인을 단정하는 표현은 피한다. 서비스 과정의 투명성과 정직성을 자연스럽게 표현한다.',
  },
  '인테리어': {
    tone: '공간 구성·활용성·실용성 중심의 실용적 톤',
    structure: '공간 개요 → 구성 요소 → 디자인 포인트 → 활용성 → 만족도',
    rules: '공간 구조·채광·재질·색감·활용성. 목적별 사용 편의성. 동선과 기능성. 과도한 미사여구 금지. 실용적 관점 중심.',
    details: '공간의 구성과 실용성을 구체적으로 설명하며 활용 방안을 제시하되, 과도한 미사여구는 사용하지 않는다. 디자인의 포인트와 기능성을 균형있게 표현한다.',
  },
  '핸드폰': {
    tone: '기능성과 서비스 중심의 실용적 톤',
    structure: '방문 계기 → 상담 → 서비스 과정 → 결과 확인 → 만족도',
    rules: '상담의 친절함과 전문성. 서비스 과정의 투명성. 수리/구매의 정직성. 제품 설명의 명확성. A/S 서비스의 신뢰감. 과장된 광고 표현 금지.',
    details: '서비스의 전문성과 신뢰감을 강조하며, 제품이나 수리 과정을 이해하기 쉽게 설명한다. 과장된 광고 표현은 피하고, 실제 경험을 바탕으로 자연스럽게 표현한다.',
  },
  '반려동물': {
    tone: '아이 반응 중심의 따뜻하고 신뢰 기반 톤',
    structure: '방문 계기 → 아이 반응 → 공간 관찰 → 서비스 내용 → 아이 만족도 → 전체 평가',
    rules: '아이(펫)의 자연스러운 반응 중심. 공간 청결·안전성·편의성. 직원의 케어·세심함·전문성. 서비스의 신뢰감. 과한 의인화 금지. 실용적 관점 유지.',
    details: '반려동물의 자연스러운 반응과 세심한 케어를 강조하되, 과도한 의인화 표현은 피한다. 공간의 안전성과 직원의 전문성을 구체적으로 묘사한다.',
  },
  '학원/스터디카페': {
    tone: '안정감·정돈·설명력 중심의 신뢰 기반 톤',
    structure: '등록/이용 계기 → 공간 분위기 → 수업/학습 환경 → 설명력/시설 → 만족도',
    rules: '안정감·정돈·조용함·집중 환경. 교습 설명력·학습 자료. 공간의 관리력·청결도. 학부모/학생 시점 모두 자연스럽게 가능. 성과 보장 금지.',
    details: '성과 보장 표현은 절대 사용하지 않으며, 교육 환경과 설명력을 중심으로 자연스럽게 표현한다. 학습 분위기와 시설의 편의성을 구체적으로 묘사한다.',
  },
  '펜션/숙소/민박/호텔': {
    tone: '채광·구조·체류감 중심의 편안하고 감성적인 톤',
    structure: '체크인 → 공간 구조 → 채광/분위기 → 편의시설 → 체류 경험 → 체크아웃',
    rules: '채광·조도·뷰·공기감 묘사. 동선, 편의시설, 침구 느낌, 온수/난방. 아침 식사/서비스. 감성적·여운 있는 문장 허용. 과장 없는 만족도 표현.',
    details: '공간의 구조와 분위기를 구체적으로 묘사하며 체류감을 전달하되, 과장된 표현은 피한다. 편의시설과 서비스의 세심함을 자연스럽게 표현한다.',
  },
  '공간대여/파티룸/스튜디오': {
    tone: '공간 활용성과 분위기 중심의 실용적 톤',
    structure: '대여 계기 → 공간 구조 → 시설/장비 → 활용 경험 → 만족도',
    rules: '공간 구조·크기·채광·음향. 시설과 장비의 상태와 다양성. 목적별 활용 편의성. 분위기와 인테리어. 관리 상태와 청결도. 과도한 미사여구 금지.',
    details: '공간의 구조와 활용성을 구체적으로 설명하며, 시설과 장비의 상태를 객관적으로 묘사한다. 목적에 맞는 활용 방안을 자연스럽게 제시하되, 과도한 미사여구는 피한다.',
  },
  '기타': {
    tone: '자연스럽고 균형잡힌 톤',
    structure: '방문/이용 계기 → 서비스/상품 관찰 → 경험 → 만족도',
    rules: '업종 특성에 맞는 자연스러운 표현. 서비스/상품의 특징과 품질. 공간/시설의 적절성. 직원의 서비스. 과장 없는 객관적 묘사.',
    details: '업종의 특성에 맞게 자연스럽게 표현하며, 서비스나 상품의 특징을 구체적으로 묘사한다. 과장된 표현은 피하고, 실제 경험을 바탕으로 균형있게 서술한다.',
  },
};

// 문장 패턴 30개 (AI 티 제거용 - 패턴 유형 지시)
const sentencePatternTypes = [
  '짧은 문장 후 긴 문장 조합',
  '감정 연결어 사용 ("솔직히", "생각보다")',
  '시간 흐름 기반 서술',
  '공간 묘사 먼저 → 내용 서술',
  '느낌 먼저 제시 후 구체 설명',
  '결론 먼저 말하는 구조',
  '비교 문장 ("전에 갔던 곳보다…")',
  '감탄문 1회 포함',
  '의문형 1회 포함',
  '구어체 10~20% 섞기',
  '묘사 + 관찰 혼합',
  '단락 첫 문장 변형(직설/질문/감성)',
  '불완전 문장 1회 포함',
  '동의어 자동 치환',
  '반복 단어 자동 회피',
  '명사 나열 → 정리형 문장',
  '문장 길이의 편차 크게',
  '감정선 한 줄 삽입',
  '의외의 디테일 1줄 삽입',
  '내적 독백 스타일 1줄',
  '"먼저 말하면…" 구조 1회',
  '여운을 주는 마무리',
  '강조 표현 1회',
  '전환구문 사용 ("그러다 보니", "게다가")',
  '경험 기반 추론 삽입',
  '부드러운 톤 + 리듬 불규칙',
  '첫 문장 후킹 스타일',
  '두 번째 문장은 매우 짧게',
  '감성톤 마무리',
  '전체 문단의 예측 가능성 제거',
];

// 플레이스 링크 중간 삽입 문구 30개
const placeLinkInsertPhrases = [
  '자세한 정보는 여기서 확인하실 수 있습니다.',
  '더 많은 정보가 궁금하시다면 이곳을 방문해보세요.',
  '상세한 위치와 정보는 여기서 확인 가능합니다.',
  '방문 전에 이곳에서 미리 확인해보시면 좋을 것 같습니다.',
  '자세한 내용은 여기서 확인하실 수 있어요.',
  '더 알아보고 싶으시다면 이곳을 클릭해보세요.',
  '상세 정보는 여기서 확인하시면 됩니다.',
  '이곳에서 더 많은 정보를 확인할 수 있습니다.',
  '자세한 안내는 여기서 받으실 수 있어요.',
  '더 궁금한 점이 있으시다면 이곳을 방문해보세요.',
  '상세한 위치 정보는 여기서 확인 가능합니다.',
  '자세한 내용이 궁금하시다면 이곳을 클릭해보세요.',
  '더 많은 정보는 여기서 확인하실 수 있습니다.',
  '이곳에서 상세한 안내를 받으실 수 있어요.',
  '자세한 정보가 필요하시다면 여기서 확인해보세요.',
  '더 알아보고 싶으시면 이곳을 방문해보시면 됩니다.',
  '상세한 내용은 여기서 확인하실 수 있습니다.',
  '이곳에서 더 자세한 정보를 확인할 수 있어요.',
  '자세한 안내가 필요하시다면 여기서 확인해보세요.',
  '더 많은 내용은 이곳에서 확인하실 수 있습니다.',
  '상세 정보가 궁금하시다면 여기서 확인해보시면 됩니다.',
  '이곳에서 자세한 안내를 받으실 수 있어요.',
  '더 알아보고 싶으시다면 이곳을 클릭해보세요.',
  '자세한 정보는 여기서 확인 가능합니다.',
  '상세한 내용이 필요하시다면 이곳을 방문해보세요.',
  '더 많은 정보는 여기서 확인하실 수 있어요.',
  '이곳에서 상세한 안내를 받으실 수 있습니다.',
  '자세한 안내가 궁금하시다면 여기서 확인해보시면 됩니다.',
  '더 알아보고 싶으시면 이곳을 클릭해보세요.',
  '상세 정보는 여기서 확인하실 수 있습니다.',
];

interface BuildPromptInput {
  clientName: string;
  placeUrl: string | null;
  category: Category | null;
  guideText: string;
  keywords: string | null;
  contentType: 'review' | 'info';
  lengthHint: 1000 | 1500;
  imageDescriptions?: string[];
  humanExtraPrompt?: string | null;
  stylePreset?: StylePreset | null;
}

export function buildPrompt(input: BuildPromptInput): string {
  const {
    clientName,
    placeUrl,
    category,
    guideText,
    keywords,
    contentType,
    lengthHint,
    imageDescriptions = [],
    humanExtraPrompt,
    stylePreset,
  } = input;

  let prompt = '';

  // 1. 기본 지시사항 (AI 티 제거)
  prompt += `${clientName}에 대한 ${contentType === 'review' ? '후기' : '정보'} 글을 작성해주세요. 실제로 방문하거나 이용한 사람의 입장에서 솔직하고 자연스럽게 작성해주세요.\n\n`;

  // 2. 스타일 프리셋 우선 적용
  if (stylePreset) {
    if (stylePreset.tone) {
      prompt += `톤: ${stylePreset.tone}\n`;
    }
    if (stylePreset.length_hint) {
      prompt += `길이 힌트: ${stylePreset.length_hint}\n`;
    }
    if (stylePreset.platform) {
      prompt += `플랫폼: ${stylePreset.platform}\n`;
    }
    if (stylePreset.extra_rules) {
      prompt += `추가 규칙: ${stylePreset.extra_rules}\n`;
    }
    prompt += '\n';
  } else if (category && categoryStyles[category]) {
    // 3. 업종 스타일 자동 적용 (고도화 버전)
    const style = categoryStyles[category];
    prompt += `[업종 스타일: ${category}]\n`;
    prompt += `톤: ${style.tone}\n`;
    prompt += `구조: ${style.structure}\n`;
    prompt += `규칙: ${style.rules}\n`;
    prompt += `세부사항: ${style.details}\n\n`;
  }

  // 4. 가이드 텍스트
  prompt += `[가이드]\n${guideText}\n\n`;

  // 4-1. 키워드 (있는 경우)
  if (keywords && keywords.trim()) {
    const keywordList = keywords.split(',').map(k => k.trim()).filter(k => k.length > 0);
    if (keywordList.length > 0) {
      prompt += `[필수 키워드]\n다음 키워드들을 제목과 본문에 자연스럽게 여러 번 포함해야 합니다: ${keywordList.join(', ')}\n`;
      prompt += `키워드는 인위적이지 않게 문맥에 자연스럽게 녹여서 사용하세요.\n\n`;
    }
  }

  // 5. Vision Soft Embedding 규칙 (AI 티 제거 핵심)
  if (imageDescriptions.length > 0) {
    prompt += `[사진 분석 결과 - 참고용]\n${imageDescriptions.join('\n')}\n\n`;
    prompt += `⚠️ 매우 중요 - Vision Soft Embedding 규칙:\n`;
    prompt += `Vision 분석 결과의 문장을 직접 사용하지 말고, 사진을 보고 사람이 느낄 법한 분위기와 인상을 서술형 문장 안에 자연스럽게 간접적으로만 녹여내라.\n`;
    prompt += `예: X "화이트 톤의 공간이며 조명이 밝다." → O "전체적으로 빛이 부드럽게 퍼져서 분위기가 깨끗하게 느껴졌다."\n\n`;
  }

  // 6. 문장 패턴 랜덤 적용 (4~7개) - AI 패턴 차단 장치
  const patternCount = Math.floor(Math.random() * 4) + 4; // 4~7개
  const selectedPatterns = [...sentencePatternTypes]
    .sort(() => Math.random() - 0.5)
    .slice(0, patternCount);
  prompt += `[문장 리듬 변주 - AI 패턴 차단]\n다음 문장 패턴 유형들을 자연스럽게 적용하여 문장 리듬을 인간처럼 불규칙하게 만들어라:\n${selectedPatterns.map((p, i) => `${i + 1}. ${p}`).join('\n')}\n`;
  prompt += `목적: 동일 문장 패턴 반복을 차단하고, 문장의 리듬을 인간 수준으로 변주한다.\n\n`;

  // 7. 콘텐츠 타입별 자연스러운 톤 규칙
  if (contentType === 'review') {
    prompt += `[후기형 글의 자연스러운 인간 톤 규칙]\n`;
    prompt += `- 과장형, 광고형 문장 금지 ("최고다", "완벽하다" 등)\n`;
    prompt += `- 작은 감정 + 구체적 관찰 조합\n`;
    prompt += `- 설명만 나열 금지 → 느낌·상황·맥락 섞기\n`;
    prompt += `- 미세한 감정 표현 자연스럽게 추가\n`;
    prompt += `- 표현을 동일하게 반복하지 않기\n`;
    prompt += `- 문단마다 시점·디테일·관찰 포인트 약간 변화\n`;
    prompt += `- 실제 방문 반복자처럼 "조심스러운 표현" 1~2개 삽입\n`;
    prompt += `- 말투: "~했어요", "~였어요" 같은 구어체 자연스럽게 사용\n`;
    prompt += `- 기승전결 구조로 자연스럽게 이어지게 작성\n`;
    prompt += `예: "생각보다 공간이 조용해서 마음이 편해졌다." / "설명 들으면서 자연스럽게 긴장이 풀렸던 순간이 있었다."\n\n`;
  } else {
    prompt += `[정보형 글의 중립·사실 기반 규칙]\n`;
    prompt += `- 광고성/미사여구 금지\n`;
    prompt += `- 장점/특징을 중립적 어조로 설명\n`;
    prompt += `- 사실 → 설명 → 정리 흐름 유지\n`;
    prompt += `- 너무 매뉴얼처럼 딱딱한 어조 금지\n`;
    prompt += `- 객관적·부드러운 설명 중심\n`;
    prompt += `예: O "이 공간은 자연광이 잘 들어 촬영용으로 자주 활용된다." / X "이곳은 최고의 촬영 공간이다!"\n\n`;
  }

  // 8. 텍스트 리듬(문장 흐름) 규칙
  prompt += `[텍스트 리듬 규칙]\n`;
  prompt += `- 문장 길이를 다양하게 섞기\n`;
  prompt += `- 단락마다 시작 문장의 톤 변환\n`;
  prompt += `- 시각·촉각·감정 묘사를 교차 사용\n`;
  prompt += `- 개념적 표현 + 구체적 사례 혼합\n`;
  prompt += `- 정보형/후기형 모두 '자연스러운 틈'(쉼표·여백·리듬) 허용\n`;
  prompt += `- 예측 가능성 제거: 같은 구조 반복 금지\n\n`;

  // 9. 블로그 원고 작성 규칙
  prompt += `[블로그 원고 작성 필수 규칙]\n`;
  prompt += `1. 제목을 반드시 작성하고, 후킹 요소가 들어가게 작성하세요.\n`;
  prompt += `2. 제목과 본문에 키워드를 필수로 포함하세요. (자연스럽게 여러 번 활용)\n`;
  prompt += `3. 제목에 "~후기" 단어는 사용하지 마세요.\n`;
  prompt += `4. 본문은 문단을 나누지 않고 연속으로 작성하세요.\n`;
  prompt += `5. 글 시작 부분에 이슈 얘기, 인사, 날씨 얘기 등을 자연스럽게 포함하여 진짜 블로거가 쓴 것처럼 작성하세요.\n`;
  prompt += `6. 기승전결 구조에 맞춰 자연스럽게 이어지게 작성하세요.\n`;
  prompt += `7. 사진과 요청사항을 제대로 참고하여 작성하세요.\n`;
  prompt += `8. 길이: 약 ${lengthHint}자 정도로 작성하세요.\n`;
  if (placeUrl) {
    prompt += `9. 플레이스 링크는 반드시 글의 가장 첫 번째 문단(제목 바로 다음) 또는 가장 마지막 문단 중 하나에만 포함하세요.\n`;
    prompt += `   - 중간에는 절대 넣지 마세요.\n`;
    prompt += `   - 첫 번째 문단에 넣는 경우: 제목 다음 바로 링크를 포함하고, 그 다음에 본문을 작성하세요.\n`;
    prompt += `   - 마지막 문단에 넣는 경우: 본문을 모두 작성한 후, 마지막 문단으로 링크를 포함하세요.\n`;
  }
  prompt += `\n`;
  
  prompt += `[금지사항]\n`;
  prompt += `- "소개해볼까해요", "들려드릴게요" 등 부자연스러운 표현 사용 금지\n`;
  prompt += `- 과도한 홍보성 톤 사용 금지\n`;
  prompt += `- 문장들을 두서없이 나열하지 말 것\n`;
  prompt += `- 제목에 "~후기" 단어 사용 금지\n\n`;

  // 10. 플레이스 링크 삽입 위치 결정 (맨 위 또는 맨 아래 중 하나로 랜덤)
  if (placeUrl) {
    const randomPhrase = placeLinkInsertPhrases[Math.floor(Math.random() * placeLinkInsertPhrases.length)];
    const linkPosition = Math.random() < 0.5 ? 'top' : 'bottom'; // 50% 확률로 맨 위 또는 맨 아래
    
    if (linkPosition === 'top') {
      prompt += `[플레이스 링크 - 매우 중요 - 맨 위 배치]\n`;
      prompt += `⚠️⚠️⚠️ 절대적으로 중요: 플레이스 링크는 반드시 글의 가장 첫 번째 문단(제목 바로 다음)에만 포함해야 합니다.\n`;
      prompt += `⚠️⚠️⚠️ 다음 형식으로 첫 번째 문단에 링크를 포함하세요: "${randomPhrase}" ${placeUrl}\n`;
      prompt += `⚠️⚠️⚠️ 절대 글 중간이나 마지막에 링크를 넣지 마세요. 오직 첫 번째 문단(제목 바로 다음)에만 넣어야 합니다.\n`;
      prompt += `⚠️⚠️⚠️ 본문 내용을 작성하기 전에, 제목 다음 첫 번째 문단으로 링크를 먼저 포함하세요.\n`;
      prompt += `⚠️⚠️⚠️ 링크를 포함한 후에 본문 내용을 이어서 작성하세요.\n\n`;
    } else {
      prompt += `[플레이스 링크 - 매우 중요 - 맨 아래 배치]\n`;
      prompt += `⚠️⚠️⚠️ 절대적으로 중요: 플레이스 링크는 반드시 글의 가장 마지막 문단에만 포함해야 합니다.\n`;
      prompt += `⚠️⚠️⚠️ 다음 형식으로 마지막 문단에 링크를 포함하세요: "${randomPhrase}" ${placeUrl}\n`;
      prompt += `⚠️⚠️⚠️ 절대 글 중간이나 앞부분에 링크를 넣지 마세요. 오직 마지막 문단에만 넣어야 합니다.\n`;
      prompt += `⚠️⚠️⚠️ 본문 내용을 모두 작성한 후, 그 다음에 마지막 문단으로 링크를 포함하세요.\n`;
      prompt += `⚠️⚠️⚠️ 링크를 포함한 후에는 더 이상 내용을 추가하지 마세요.\n\n`;
    }
  }

  // 11. 추가 프롬프트
  if (humanExtraPrompt) {
    prompt += `[추가 요청사항]\n${humanExtraPrompt}\n\n`;
  }

  // 12. AI 티 제거용 필수 프롬프트 문구
  prompt += `[AI 티 제거 필수 지시사항]\n`;
  prompt += `설명 문장만 나열하지 말고, 자연스러운 관찰·느낌·맥락을 섞어 사람이 직접 쓴 글처럼 표현하라.\n`;
  prompt += `문장 리듬은 규칙적이지 않게 변주하고, 같은 표현을 반복하지 마라.\n`;
  prompt += `광고 톤·과장 표현·AI 패턴은 절대 사용하지 말라.\n`;
  prompt += `검색엔진(SEO)에 잘 노출되도록 키워드를 자연스럽게 여러 번 활용하되, 인위적인 느낌이 들지 않게 해라.\n`;
  prompt += `플레이스 링크는 반드시 글의 가장 첫 번째 문단(제목 바로 다음) 또는 가장 마지막 문단 중 하나에만 포함하고, 중간에는 절대 넣지 마라. 자연스럽게 녹여내되, 광고처럼 보이지 않게 해라.\n`;
  prompt += `진짜 블로거가 쓴 것처럼 자연스럽고 진정성 있게 작성하라.\n\n`;

  // 13. 최종 요청
  if (placeUrl) {
    prompt += `위 모든 요구사항을 반영하여, 제목과 본문을 포함한 완전한 블로그 원고를 작성해주세요. 사람이 직접 쓴 것처럼 자연스럽고 AI 티 없는 글이어야 합니다.\n`;
    prompt += `\n⚠️⚠️⚠️ 최종 확인: 플레이스 링크는 반드시 첫 번째 문단(제목 바로 다음) 또는 마지막 문단 중 하나에만 포함되어야 합니다. 중간에는 절대 포함하지 마세요.`;
  } else {
    prompt += `위 모든 요구사항을 반영하여, 제목과 본문을 포함한 완전한 블로그 원고를 작성해주세요. 사람이 직접 쓴 것처럼 자연스럽고 AI 티 없는 글이어야 합니다.`;
  }

  return prompt;
}

