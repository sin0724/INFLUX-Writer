import { Category, StylePreset } from './types';

// 업종별 스타일 규칙 (고도화 버전)
const categoryStyles: Record<Category, { tone: string; structure: string; rules: string; details: string }> = {
  '네일': {
    tone: '디테일 중심의 편안하고 섬세한 톤',
    structure: '디자인 선택 → 시술 과정 → 디테일 강조 → 완성 후 느낌',
    rules: '네일 아트 디테일 강조 (컬러, 패턴, 질감, 마감). 시술 중 편안함과 전문성 묘사. 손톱 상태 변화 관찰. 가벼운 대화체 자연스럽게 사용.',
    details: '디자인 선택 과정을 구체적으로 서술하고, 시술 중 느낀 편안함과 전문가의 섬세함을 표현한다. 완성 후의 디테일과 질감을 생생하게 묘사하되, 과장된 표현은 피한다.',
  },
  '속눈썹/눈썹/메이크업': {
    tone: '변화와 디테일 중심의 섬세한 톤',
    structure: '상담 → 디자인 선택 → 시술 과정 → 변화 관찰 → 만족도',
    rules: '속눈썹/눈썹 컬, 두께, 길이, 각도 등 구체적 디테일. 메이크업의 색감, 질감, 지속력. 시술 중 편안함과 전문가의 기술력. 자연스러운 변화 강조.',
    details: '시술 전후의 변화를 구체적으로 관찰하고, 디테일한 부분(컬의 방향, 색감의 자연스러움 등)을 섬세하게 묘사한다. 전문가의 기술과 상담 능력을 자연스럽게 강조하되, 과장은 피한다.',
  },
  '왁싱/피부관리/체형관리': {
    tone: '안정적·차분·신뢰 기반의 전문적 톤',
    structure: '상담 → 과정 설명 → 시술 경험 → 느낌 → 결과 관찰',
    rules: '의료법 금지 표현 자동 제거. 시술 과정은 "느낌 중심", 효과 단정 금지. 시술 중 편안함과 전문성. 피부 상태 변화 관찰. 체형 관리의 과정과 방법 설명.',
    details: '상담·청결·조도·설명력 중심으로 자연스럽게 서술하되, 과장이나 효과 보장 표현은 절대 사용하지 않는다. 시술 중 느낀 편안함과 전문가의 케어를 구체적으로 표현한다.',
  },
  '미용실': {
    tone: 'Before→After 변화 중심의 생동감 있는 톤',
    structure: 'Before 상태 → 상담 및 제안 → 시술 과정 → After 변화 → 만족도',
    rules: '헤어 질감·볼륨·광택 등 촉각적 표현. 디자이너의 제안·설명력·기술력 강조. 변화의 자연스러움과 스타일링의 편의성. 시술 중 대화와 분위기.',
    details: '변화를 명확하게 보여주되 과장하지 않고, 실제 느낀 질감과 변화를 구체적으로 묘사한다. 디자이너의 전문성과 상담 능력을 자연스럽게 강조한다.',
  },
  '꽃집/공방': {
    tone: '감성과 디테일 중심의 따뜻한 톤',
    structure: '방문 계기 → 공간 분위기 → 작품/상품 관찰 → 제작 과정/서비스 → 감상',
    rules: '공간의 감성적 분위기 (향, 색감, 조명). 작품/상품의 디테일과 의미. 제작 과정의 섬세함. 직원의 친절함과 전문성. 구매/체험 경험의 만족도.',
    details: '공간의 감성적 분위기와 작품의 디테일을 구체적으로 묘사한다. 제작 과정이나 서비스의 섬세함을 자연스럽게 표현하되, 과도한 감성 표현은 피한다.',
  },
  '맛집/술집': {
    tone: '방문 흐름 기반의 생동감 있고 친근한 톤',
    structure: '입장 → 분위기 관찰 → 주문 → 음식/술 경험 → 식사/마시기 → 마무리',
    rules: '방문 흐름 기반 서사. 음식/술의 향→맛→식감 순서. 분위기와 공간감. 직원의 서비스. 과장형 감탄 금지. 자연스러운 만족도 표현.',
    details: '음식과 술의 식감과 맛을 구체적이고 생생하게 표현하되, "최고다" 같은 과장 표현은 사용하지 않는다. 공간의 분위기와 서비스를 자연스럽게 묘사한다.',
  },
  '카페/디저트': {
    tone: '향·식감·공간 분위기 중심의 감성적이고 편안한 톤',
    structure: '방문 계기 → 공간 분위기 → 메뉴 선택 → 감각 묘사 → 디저트 경험 → 분위기',
    rules: '향·식감·소리·온도 등 오감 묘사. 공간 분위기·빛·좌석감 중심. 메뉴와 디저트 1~2개 집중 묘사. 커피/차의 향과 맛의 디테일. 감성적이되 과장 없는 표현.',
    details: '다섯 감각을 활용한 생생한 묘사를 자연스럽게 녹여내되, 과장된 표현은 피한다. 공간의 분위기와 메뉴의 디테일을 구체적으로 표현한다.',
  },
  'PT/필라테스': {
    tone: '설명력·안전감·전문성 중심의 신뢰 기반 톤',
    structure: '목표 설정 → 프로그램 설명 → 동작 수행 → 체감 변화 → 만족도',
    rules: '강사/트레이너의 설명력·케어·전문성. 동작 수행 시 느낌과 자세 교정. 공간 안전감·기구 상태·청결도 묘사. 체계적인 프로그램 구성. "효과 단정" 금지.',
    details: '안전한 운동 방법과 체계적인 프로그램을 강조하며, 성과 보장 표현(예: 살 빠진다)은 절대 사용하지 않는다. 강사의 전문성과 개인별 맞춤 케어를 자연스럽게 표현한다.',
  },
  '스포츠/운동': {
    tone: '활동성과 경험 중심의 역동적인 톤',
    structure: '참여 계기 → 시설/장비 관찰 → 활동 경험 → 체감 → 만족도',
    rules: '시설의 안전성과 청결도. 장비의 상태와 다양성. 활동 중 느낀 역동성과 즐거움. 지도자의 전문성. 공간의 활용성과 분위기. 과장된 성과 표현 금지.',
    details: '활동의 역동성과 즐거움을 생생하게 표현하되, 성과나 효과를 단정하는 표현은 피한다. 시설과 장비의 상태, 지도자의 전문성을 자연스럽게 강조한다.',
  },
  '자동차': {
    tone: '신뢰·과정 투명성·전문성 중심의 실용적 톤',
    structure: '방문 계기 → 상담 → 점검/서비스 과정 → 설명 → 결과 → 만족도',
    rules: '신뢰감·과정 투명성·정직성. 작업 이해도·설명력. 시설의 청결도와 전문성. 위험한 추정 금지 (고장 원인 단정 X). 정비/관리의 세심함.',
    details: '전문성과 신뢰감을 강조하며, 기술적 설명을 이해하기 쉽게 전달하되, 원인을 단정하는 표현은 피한다. 서비스 과정의 투명성과 정직성을 자연스럽게 표현한다.',
  },
  '인테리어': {
    tone: '공간 구성·활용성·실용성 중심의 실용적 톤',
    structure: '공간 개요 → 구성 요소 → 디자인 포인트 → 활용성 → 만족도',
    rules: '공간 구조·채광·재질·색감·활용성. 목적별 사용 편의성. 동선과 기능성. 과도한 미사여구 금지. 실용적 관점 중심.',
    details: '공간의 구성과 실용성을 구체적으로 설명하며 활용 방안을 제시하되, 과도한 미사여구는 사용하지 않는다. 디자인의 포인트와 기능성을 균형있게 표현한다.',
  },
  '핸드폰': {
    tone: '기능성과 서비스 중심의 실용적 톤',
    structure: '방문 계기 → 상담 → 서비스 과정 → 결과 확인 → 만족도',
    rules: '상담의 친절함과 전문성. 서비스 과정의 투명성. 수리/구매의 정직성. 제품 설명의 명확성. A/S 서비스의 신뢰감. 과장된 광고 표현 금지.',
    details: '서비스의 전문성과 신뢰감을 강조하며, 제품이나 수리 과정을 이해하기 쉽게 설명한다. 과장된 광고 표현은 피하고, 실제 경험을 바탕으로 자연스럽게 표현한다.',
  },
  '반려동물': {
    tone: '아이 반응 중심의 따뜻하고 신뢰 기반 톤',
    structure: '방문 계기 → 아이 반응 → 공간 관찰 → 서비스 내용 → 아이 만족도 → 전체 평가',
    rules: '아이(펫)의 자연스러운 반응 중심. 공간 청결·안전성·편의성. 직원의 케어·세심함·전문성. 서비스의 신뢰감. 과한 의인화 금지. 실용적 관점 유지.',
    details: '반려동물의 자연스러운 반응과 세심한 케어를 강조하되, 과도한 의인화 표현은 피한다. 공간의 안전성과 직원의 전문성을 구체적으로 묘사한다.',
  },
  '학원/스터디카페': {
    tone: '안정감·정돈·설명력 중심의 신뢰 기반 톤',
    structure: '등록/이용 계기 → 공간 분위기 → 수업/학습 환경 → 설명력/시설 → 만족도',
    rules: '안정감·정돈·조용함·집중 환경. 교습 설명력·학습 자료. 공간의 관리력·청결도. 학부모/학생 시점 모두 자연스럽게 가능. 성과 보장 금지.',
    details: '성과 보장 표현은 절대 사용하지 않으며, 교육 환경과 설명력을 중심으로 자연스럽게 표현한다. 학습 분위기와 시설의 편의성을 구체적으로 묘사한다.',
  },
  '펜션/숙소/민박/호텔': {
    tone: '채광·구조·체류감 중심의 편안하고 감성적인 톤',
    structure: '체크인 → 공간 구조 → 채광/분위기 → 편의시설 → 체류 경험 → 체크아웃',
    rules: '채광·조도·뷰·공기감 묘사. 동선, 편의시설, 침구 느낌, 온수/난방. 아침 식사/서비스. 감성적·여운 있는 문장 허용. 과장 없는 만족도 표현.',
    details: '공간의 구조와 분위기를 구체적으로 묘사하며 체류감을 전달하되, 과장된 표현은 피한다. 편의시설과 서비스의 세심함을 자연스럽게 표현한다.',
  },
  '공간대여/파티룸/스튜디오': {
    tone: '공간 활용성과 분위기 중심의 실용적 톤',
    structure: '대여 계기 → 공간 구조 → 시설/장비 → 활용 경험 → 만족도',
    rules: '공간 구조·크기·채광·음향. 시설과 장비의 상태와 다양성. 목적별 활용 편의성. 분위기와 인테리어. 관리 상태와 청결도. 과도한 미사여구 금지.',
    details: '공간의 구조와 활용성을 구체적으로 설명하며, 시설과 장비의 상태를 객관적으로 묘사한다. 목적에 맞는 활용 방안을 자연스럽게 제시하되, 과도한 미사여구는 피한다.',
  },
  '기타': {
    tone: '자연스럽고 균형잡힌 톤',
    structure: '방문/이용 계기 → 서비스/상품 관찰 → 경험 → 만족도',
    rules: '업종 특성에 맞는 자연스러운 표현. 서비스/상품의 특징과 품질. 공간/시설의 적절성. 직원의 서비스. 과장 없는 객관적 묘사.',
    details: '업종의 특성에 맞게 자연스럽게 표현하며, 서비스나 상품의 특징을 구체적으로 묘사한다. 과장된 표현은 피하고, 실제 경험을 바탕으로 균형있게 서술한다.',
  },
};

// 페르소나 유형 (각 원고마다 다른 페르소나 적용)
const personaTypes = [
  '감성적이고 섬세한 블로거 - 느낌과 감정을 중심으로 서술',
  '실용적이고 객관적인 리뷰어 - 사실과 경험을 중심으로 서술',
  '탐험가 스타일 - 호기심과 발견을 중심으로 서술',
  '친구처럼 편안한 블로거 - 대화하듯이 자연스럽게 서술',
  '전문가 관점 - 지식과 경험을 바탕으로 서술',
  '일상 기록자 - 일상의 순간을 담담하게 서술',
  '여행자 마인드 - 새로운 경험을 즐기는 관점으로 서술',
  '디테일 관찰자 - 세부사항과 변화를 집중적으로 서술',
];

// 문장구조 유형 (각 원고마다 다른 구조 적용)
const sentenceStructureTypes = [
  '서술형 중심 - 시간 순서대로 자연스럽게 서술',
  '묘사형 중심 - 공간과 분위기를 먼저 묘사 후 서술',
  '대화형 중심 - 독자와 대화하듯이 서술',
  '관찰형 중심 - 관찰한 내용을 중심으로 서술',
  '경험형 중심 - 경험한 순서대로 서술',
  '비교형 중심 - 전후 비교를 중심으로 서술',
  '감정형 중심 - 느낌과 감정 변화를 중심으로 서술',
  '정보형 중심 - 정보를 체계적으로 서술',
];

// 말투 유형 (각 원고마다 다른 말투 적용)
const toneTypes = [
  '구어체 중심 (70%) - "~했어요", "~였어요", "~거든요" 등 자연스러운 구어체',
  '문어체 중심 (70%) - "~했습니다", "~였습니다" 등 정중한 문어체',
  '혼합형 (50:50) - 구어체와 문어체를 자연스럽게 혼합',
  '캐주얼 구어체 (80%) - "~해요", "~거예요" 등 매우 편안한 구어체',
  '정중한 문어체 (80%) - "~했습니다", "~였습니다" 등 매우 정중한 문어체',
  '대화형 구어체 - 독자에게 직접 말하듯이 "~하시면", "~보시면" 등',
  '일상 대화형 - 친구에게 말하듯이 "~했는데", "~였는데" 등',
  '중립형 - 구어체와 문어체를 균형있게 사용',
];

// 서론 시작 화두 유형 (각 원고마다 다른 화두로 시작)
const openingHookTypes = [
  '날씨/계절 언급 - "오늘 날씨가 ~해서", "요즘 날씨가 ~하네요" 등',
  '일상 이야기 - "요즘 ~하느라 바빴는데", "평소에 ~하는 편인데" 등',
  '방문 계기 - "~해서 이번에 방문하게 되었어요", "~한 이유로 찾아봤어요" 등',
  '최근 경험 - "최근에 ~했던 경험이 생각나서", "얼마 전 ~했는데" 등',
  '추천 받음 - "친구가 ~라고 추천해서", "~분이 추천해주셔서" 등',
  '우연한 발견 - "지나가다가 우연히 발견했어요", "길을 걷다가 ~를 봤어요" 등',
  '궁금증 - "~가 궁금해서 찾아봤어요", "~에 대해 알아보고 싶어서" 등',
  '비교/대조 - "전에 갔던 곳과는 달리", "다른 곳과 비교해보면" 등',
  '질문으로 시작 - "~한 곳을 찾고 계신가요?", "~에 대해 궁금하신가요?" 등',
  '감정/느낌으로 시작 - "~한 기분이 들어서", "~한 느낌이 들어" 등',
  '시간/시기 언급 - "요즘 ~한 시기라서", "~할 때가 되면" 등',
  '공간/장소 첫인상 - "처음 들어서는 순간", "문을 열고 들어가니" 등',
  '기대감 - "~할 거라고 기대했는데", "~할 줄 알았어요" 등',
  '호기심 - "~가 어떻게 되어있을까 궁금해서", "~한 게 신기해서" 등',
  '추억/기억 - "예전에 ~했던 기억이 나서", "~했던 때가 생각나서" 등',
  '문제 해결 - "~한 문제가 있어서", "~한 게 필요해서" 등',
  '트렌드/유행 - "요즘 ~가 유행이라서", "~가 핫해서" 등',
  '특별한 날 - "~한 날이라서", "기념일이라" 등',
  '직접적 경험 - "직접 가보니", "실제로 보니까" 등',
  '인상 깊은 점 - "~한 게 인상 깊었어요", "~한 부분이 눈에 띄었어요" 등',
  '변화/차이 - "예전과 달리", "이전과는 다른" 등',
  '추천 이유 - "~한 분들께 추천하고 싶어서", "~한 사람에게 좋을 것 같아서" 등',
  '비교 대상 - "다른 곳과 비교하면", "비슷한 곳들 중에서" 등',
  '개인적 취향 - "~하는 걸 좋아해서", "~한 스타일을 선호해서" 등',
  '우연한 기회 - "마침 ~할 기회가 생겨서", "우연히 ~하게 되어서" 등',
];

// 문장 패턴 30개 (AI 티 제거용 - 패턴 유형 지시)
const sentencePatternTypes = [
  '짧은 문장 후 긴 문장 조합',
  '감정 연결어 사용 ("솔직히", "생각보다")',
  '시간 흐름 기반 서술',
  '공간 묘사 먼저 → 내용 서술',
  '느낌 먼저 제시 후 구체 설명',
  '결론 먼저 말하는 구조',
  '비교 문장 ("전에 갔던 곳보다…")',
  '감탄문 1회 포함',
  '의문형 1회 포함',
  '구어체 10~20% 섞기',
  '묘사 + 관찰 혼합',
  '단락 첫 문장 변형(직설/질문/감성)',
  '불완전 문장 1회 포함',
  '동의어 자동 치환',
  '반복 단어 자동 회피',
  '명사 나열 → 정리형 문장',
  '문장 길이의 편차 크게',
  '감정선 한 줄 삽입',
  '의외의 디테일 1줄 삽입',
  '내적 독백 스타일 1줄',
  '"먼저 말하면…" 구조 1회',
  '여운을 주는 마무리',
  '강조 표현 1회',
  '전환구문 사용 ("그러다 보니", "게다가")',
  '경험 기반 추론 삽입',
  '부드러운 톤 + 리듬 불규칙',
  '첫 문장 후킹 스타일',
  '두 번째 문장은 매우 짧게',
  '감성톤 마무리',
  '전체 문단의 예측 가능성 제거',
];

// placeLinkInsertPhrases 배열 제거됨 - 사용하지 않음

interface BuildPromptInput {
  clientName: string;
  placeUrl: string | null;
  category: Category | null;
  guideText: string;
  keywords: string | null;
  contentType: 'review' | 'info';
  lengthHint: 1000 | 1500;
  imageDescriptions?: string[];
  humanExtraPrompt?: string | null;
  stylePreset?: StylePreset | null;
}

export function buildPrompt(input: BuildPromptInput): string {
  const {
    clientName,
    placeUrl,
    category,
    guideText,
    keywords,
    contentType,
    lengthHint,
    imageDescriptions = [],
    humanExtraPrompt,
    stylePreset,
  } = input;

  // 현재 날짜 및 계절 정보
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1; // 1-12
  const day = now.getDate();
  
  // 계절 판단
  let season = '';
  let seasonDescription = '';
  let weatherDescription = '';
  
  if (month >= 3 && month <= 5) {
    season = '봄';
    seasonDescription = '봄철';
    weatherDescription = '따뜻하고 쾌적한 날씨';
  } else if (month >= 6 && month <= 8) {
    season = '여름';
    seasonDescription = '여름철';
    weatherDescription = '더운 날씨';
  } else if (month >= 9 && month <= 11) {
    season = '가을';
    seasonDescription = '가을철';
    weatherDescription = '선선하고 쾌적한 날씨';
  } else {
    season = '겨울';
    seasonDescription = '겨울철';
    if (month === 12 || month === 1) {
      weatherDescription = '추운 날씨';
    } else {
      weatherDescription = '춥고 쌀쌀한 날씨';
    }
  }

  let prompt = '';

  // 1. 기본 지시사항 (AI 티 제거)
  prompt += `${clientName}에 대한 ${contentType === 'review' ? '후기' : '정보'} 글을 작성해주세요. 실제로 방문하거나 이용한 사람의 입장에서 솔직하고 자연스럽게 작성해주세요.\n\n`;

  // 2. 스타일 프리셋 우선 적용
  if (stylePreset) {
    if (stylePreset.tone) {
      prompt += `톤: ${stylePreset.tone}\n`;
    }
    if (stylePreset.length_hint) {
      prompt += `길이 힌트: ${stylePreset.length_hint}\n`;
    }
    if (stylePreset.platform) {
      prompt += `플랫폼: ${stylePreset.platform}\n`;
    }
    if (stylePreset.extra_rules) {
      prompt += `추가 규칙: ${stylePreset.extra_rules}\n`;
    }
    prompt += '\n';
  } else if (category && categoryStyles[category]) {
    // 3. 업종 스타일 자동 적용 (고도화 버전)
    const style = categoryStyles[category];
    prompt += `[업종 스타일: ${category}]\n`;
    prompt += `톤: ${style.tone}\n`;
    prompt += `구조: ${style.structure}\n`;
    prompt += `규칙: ${style.rules}\n`;
    prompt += `세부사항: ${style.details}\n\n`;
  }

  // 4. 가이드 텍스트 (기본 가이드)
  prompt += `[기본 가이드]\n${guideText}\n`;
  if (humanExtraPrompt) {
    prompt += `\n⚠️ 참고: 아래에 추가 요청사항이 있을 경우, 추가 요청사항이 기본 가이드보다 우선적으로 적용됩니다.\n`;
  }
  prompt += `\n`;

  // 4-1. 키워드 (있는 경우)
  if (keywords && keywords.trim()) {
    const keywordList = keywords.split(',').map(k => k.trim()).filter(k => k.length > 0);
    if (keywordList.length > 0) {
      prompt += `[필수 키워드]\n다음 키워드들을 제목과 본문에 자연스럽게 여러 번 포함해야 합니다: ${keywordList.join(', ')}\n`;
      prompt += `키워드는 인위적이지 않게 문맥에 자연스럽게 녹여서 사용하세요.\n\n`;
    }
  }

  // 5. Vision Soft Embedding 규칙
  if (imageDescriptions.length > 0) {
    prompt += `[사진 분석 결과]\n${imageDescriptions.join('\n')}\n\n`;
    prompt += `[Vision 활용 규칙]\n`;
    prompt += `- 분석 결과 문장 직접 사용 금지\n`;
    prompt += `- 시각적 인상/분위기만 간접적으로 활용\n`;
    prompt += `- 숫자/영어는 절대 사용 금지 (오인식 가능)\n`;
    prompt += `예: X "화이트 톤의 공간" → O "빛이 부드럽게 퍼져 깨끗한 느낌"\n\n`;
  }

  // 6. 페르소나, 문장구조, 말투, 서론 화두 랜덤 선택
  const selectedPersona = personaTypes[Math.floor(Math.random() * personaTypes.length)];
  const selectedStructure = sentenceStructureTypes[Math.floor(Math.random() * sentenceStructureTypes.length)];
  const selectedTone = toneTypes[Math.floor(Math.random() * toneTypes.length)];
  let selectedOpeningHook = openingHookTypes[Math.floor(Math.random() * openingHookTypes.length)];
  const patternCount = Math.floor(Math.random() * 4) + 4;
  const selectedPatterns = [...sentencePatternTypes]
    .sort(() => Math.random() - 0.5)
    .slice(0, patternCount);
  
  // 날씨/계절 관련 서론 화두인 경우 실제 날짜 정보로 대체
  if (selectedOpeningHook.includes('날씨/계절')) {
    selectedOpeningHook = `날씨/계절 언급 - 현재는 ${year}년 ${month}월 ${day}일 ${seasonDescription}입니다. "${month}월의 ${weatherDescription}를 느끼며", "요즘 ${season} 날씨가 ~해서" 등 현재 날짜와 계절에 맞는 자연스러운 표현을 사용하세요.`;
  }
  
  prompt += `[현재 날짜 정보]\n`;
  prompt += `작성일: ${year}년 ${month}월 ${day}일\n`;
  prompt += `계절: ${season} (${seasonDescription})\n`;
  prompt += `날씨 특징: ${weatherDescription}\n`;
  prompt += `⚠️ 날씨/계절 언급 시 반드시 위 날짜와 계절 정보를 기준으로 작성하세요.\n\n`;
  
  prompt += `[작성 스타일 - 각 원고마다 다르게]\n`;
  prompt += `페르소나: ${selectedPersona}\n`;
  prompt += `문장구조: ${selectedStructure}\n`;
  prompt += `말투: ${selectedTone}\n`;
  prompt += `서론 화두: ${selectedOpeningHook}\n`;
  prompt += `문장 패턴: ${selectedPatterns.map((p, i) => `${i + 1}. ${p}`).join(', ')}\n`;
  prompt += `⚠️ 다른 원고와 동일한 스타일 사용 금지\n\n`;

  // 7. 콘텐츠 타입별 규칙
  if (contentType === 'review') {
    prompt += `[후기형 규칙]\n`;
    prompt += `- 과장/광고 문장 금지\n`;
    prompt += `- 감정+관찰 조합\n`;
    prompt += `- 구어체 자연스럽게 사용\n`;
    prompt += `- 기승전결 구조\n\n`;
  } else {
    prompt += `[정보형 규칙]\n`;
    prompt += `- 중립적 어조\n`;
    prompt += `- 사실 기반 설명\n`;
    prompt += `- 객관적 표현\n\n`;
  }

  // 9. 블로그 원고 작성 규칙
  prompt += `[블로그 원고 작성 필수 규칙]\n`;
  prompt += `1. 제목 작성 (후킹 요소 포함, "~후기" 단어 사용 금지)\n`;
  prompt += `2. 키워드를 제목과 본문에 자연스럽게 여러 번 포함\n`;
  prompt += `3. 본문은 문단 구분 없이 연속 작성\n`;
  prompt += `4. 서론은 위에서 지정된 화두로 시작 (날씨만 반복 금지)\n`;
  prompt += `5. 기승전결 구조로 자연스럽게 작성\n`;
  prompt += `6. 길이: 약 ${lengthHint}자\n\n`;
  
  // 10. 플레이스 링크 금지 문구 (매우 강력하게 강조)
  if (placeUrl) {
    prompt += `[플레이스 링크 절대 금지 문구 - 반드시 읽으세요]\n`;
    prompt += `🚫🚫🚫 다음 문구들은 절대 사용하지 마세요:\n`;
    prompt += `- "이곳에서 상세한 안내를 받으실 수 있습니다"\n`;
    prompt += `- "자세한 안내는 여기서 받으실 수 있어요"\n`;
    prompt += `- "더 많은 정보는 여기서 확인하실 수 있습니다"\n`;
    prompt += `- "여기를 클릭해보세요"\n`;
    prompt += `- "자세한 정보는 여기서"\n`;
    prompt += `- "이곳을 방문해보세요"\n`;
    prompt += `- "상세한 안내를 받으실 수 있습니다"\n`;
    prompt += `- "자세한 안내를 받으실 수 있어요"\n`;
    prompt += `- "이곳에서 자세한 안내를"\n`;
    prompt += `- "여기서 상세한 안내를"\n`;
    prompt += `- 위와 유사한 모든 문구 금지\n\n`;
    prompt += `✅ 올바른 방법: 링크 URL만 자연스럽게 포함 (예: "https://place.map.kakao.com/12345678")\n`;
    prompt += `✅ 링크는 첫 번째 문단(제목 다음) 또는 마지막 문단에만 포함\n`;
    prompt += `✅ 링크 앞뒤에 설명 문구 없이 링크만 포함\n\n`;
  }

  // 11. 플레이스 링크 삽입 위치 결정 (맨 위 또는 맨 아래 중 하나로 랜덤)
  if (placeUrl) {
    const linkPosition = Math.random() < 0.5 ? 'top' : 'bottom';
    
    if (linkPosition === 'top') {
      prompt += `[플레이스 링크 배치: 첫 번째 문단]\n`;
      prompt += `링크 URL: ${placeUrl}\n`;
      prompt += `위치: 제목 다음 첫 번째 문단에만 포함\n`;
      prompt += `방법: 링크만 포함 (설명 문구 없음)\n\n`;
    } else {
      prompt += `[플레이스 링크 배치: 마지막 문단]\n`;
      prompt += `링크 URL: ${placeUrl}\n`;
      prompt += `위치: 본문 마지막 문단에만 포함\n`;
      prompt += `방법: 링크만 포함 (설명 문구 없음)\n\n`;
    }
  }

  // 12. 추가 프롬프트 (우선순위 최우선)
  if (humanExtraPrompt) {
    prompt += `[추가 요청사항 - 최우선]\n`;
    prompt += `⚠️ 기본 가이드보다 우선 적용\n`;
    prompt += `${humanExtraPrompt}\n\n`;
  }

  // 12. 최종 금지 사항 및 중요 지시사항 (간결하게 정리)
  prompt += `[최종 금지 사항 - 반드시 준수]\n`;
  prompt += `🚫 플레이스 링크 관련 금지 문구:\n`;
  prompt += `   - "이곳에서 상세한 안내를 받으실 수 있습니다"\n`;
  prompt += `   - "자세한 안내는 여기서 받으실 수 있어요"\n`;
  prompt += `   - "더 많은 정보는 여기서 확인하실 수 있습니다"\n`;
  prompt += `   - "여기를 클릭해보세요", "이곳을 방문해보세요" 등 모든 유사 문구\n`;
  prompt += `🚫 기타 금지:\n`;
  prompt += `   - "소개해볼까해요", "들려드릴게요" 등 부자연스러운 표현\n`;
  prompt += `   - 과도한 홍보성 톤\n`;
  prompt += `   - 제목에 "~후기" 단어\n`;
  prompt += `   - 사진에서 본 숫자/영어 (Vision API 오인식 가능)\n\n`;
  
  prompt += `[작성 원칙]\n`;
  prompt += `- 자연스러운 관찰·느낌·맥락 포함\n`;
  prompt += `- 문장 리듬 불규칙하게 변주\n`;
  prompt += `- 같은 표현 반복 금지\n`;
  prompt += `- 각 원고마다 다른 페르소나/문장구조/말투/서론 화두 사용\n`;
  prompt += `- 진짜 블로거가 쓴 것처럼 자연스럽게\n\n`;

  // 13. 최종 요청
  prompt += `위 모든 요구사항을 반영하여 제목과 본문을 작성하세요.\n`;
  if (placeUrl) {
    prompt += `\n🚫 최종 확인: 링크는 첫 문단 또는 마지막 문단에만 포함. 설명 문구 없이 링크만 포함.`;
  }

  return prompt;
}

